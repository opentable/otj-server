/*
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.opentable.server.reactive;

import static org.junit.Assert.assertEquals;

import java.util.SortedMap;

import com.codahale.metrics.Counter;
import com.codahale.metrics.Meter;
import com.codahale.metrics.MetricRegistry;
import com.codahale.metrics.Timer;

import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.web.reactive.server.WebTestClient;

public class ServerMetricsTest extends AbstractTest {

    @Autowired private WebTestClient webTestClient;
    @Autowired private MetricRegistry metricRegistry;

    @Test
    public void testRequestMetrics() throws InterruptedException {
        SortedMap<String, Meter> meters = metricRegistry.getMeters();
        Meter okResponseMeter = meters.get("http-server.2xx-responses");
        Meter notFoundResponseMeter = meters.get("http-server.4xx-responses");
        Counter activeSuspended = metricRegistry.getCounters().get("http-server.active-suspended");
        Timer requests = metricRegistry.getTimers().get("http-server.requests");
        Timer dispatches = metricRegistry.getTimers().get("http-server.dispatches");

        long currentOk = okResponseMeter.getCount();
        long currentNotFound = notFoundResponseMeter.getCount();
        long currentSuspended = activeSuspended.getCount();
        long currentRequests = requests.getCount();
        long currentDispatches = dispatches.getCount();

        for (int i = 0; i < 123; i++) {
            webTestClient.get().uri("/api/test").exchange().expectBody(String.class).returnResult();
        }
        for (int i = 0; i < 51; i++) {
            webTestClient.get().uri("/totally/fake").exchange().expectBody(String.class).returnResult();
        }
        Thread.sleep(2000l);
        // Do all the metrics filter through?
        // We expect 123 200s from the /api/test endpoint
        assertEquals(123, okResponseMeter.getCount() - currentOk);
        // ... and 51 404s from the /totally/fake one
        assertEquals(51, notFoundResponseMeter.getCount() - currentNotFound);
        assertEquals(0, activeSuspended.getCount() - currentSuspended);

        // We expect total request and total dispatches to be 174. Since there were
        // no async delays, dispatches = requests (at least I think that's the idea
        assertEquals(174, requests.getCount() - currentRequests);
        assertEquals(174, dispatches.getCount() - currentDispatches);
    }

    @Test
    public void testAsyncRequestMetrics() throws InterruptedException {
        SortedMap<String, Meter> meters = metricRegistry.getMeters();
        Meter okResponseMeter = meters.get("http-server.2xx-responses");
        Meter notFoundResponseMeter = meters.get("http-server.4xx-responses");
        Counter activeSuspended = metricRegistry.getCounters().get("http-server.active-suspended");
        Timer requests = metricRegistry.getTimers().get("http-server.requests");
        Timer dispatches = metricRegistry.getTimers().get("http-server.dispatches");

        long currentOk = okResponseMeter.getCount();
        long currentNotFound = notFoundResponseMeter.getCount();
        long currentSuspended = activeSuspended.getCount();
        long currentRequests = requests.getCount();
        long currentDispatches = dispatches.getCount();

        for (int i = 0; i < 10; i++) {
            webTestClient.get().uri("/api/async").exchange().expectBody(String.class).returnResult();
        }
        for (int i = 0; i < 5; i++) {
            webTestClient.get().uri("/totally/fake").exchange().expectBody(String.class).returnResult();
        }
        Thread.sleep(2000l);
        // Very similar to the non async...
        assertEquals(10, okResponseMeter.getCount() - currentOk);
        assertEquals(5, notFoundResponseMeter.getCount() - currentNotFound);
        assertEquals(0, activeSuspended.getCount() - currentSuspended);
        assertEquals(15, requests.getCount() - currentRequests);
        assertEquals(15, dispatches.getCount() - currentDispatches);
    }
}
